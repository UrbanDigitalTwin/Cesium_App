<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login - Cesium App</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap");
      #tagline-rotator {
        font-size: 18px;
        font-family: "Poppins", Arial, sans-serif;
        color: #00274c;
        text-align: center;
        margin: 18px auto 24px auto;
        min-height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #tagline-rotator .blinking-cursor {
        font-weight: 600;
        font-size: 20px;
        color: #1976d2;
        margin-left: 2px;
        animation: blink 1s steps(1) infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div
      id="login-flex"
      style="display: flex; flex-direction: row; width: 100vw; height: 100vh"
    >
      <div
        id="slideshow-container"
        style="
          flex: 0 0 60vw;
          display: flex;
          padding-top: 10px;
          flex-direction: column;
          align-items: flex-start;
          justify-content: flex-start;
          background: #f7fafd;
          box-shadow: 2px 0 12px rgba(0, 0, 0, 0.07);
          padding-right: 24px;
          padding-bottom: 24px;
          height: 100vh;
          width: 100vw;
        "
      >
        <div
          id="udt-lab-title"
          style="
            margin-bottom: 8px;
            font-size: 2.3rem;
            font-weight: bold;
            color: #00274c;
            letter-spacing: 1px;
            align-self: flex-start;
            margin-left: 32px;
          "
        >
          URBAN DIGITAL TWIN LAB
        </div>
        <div
          id="tagline-rotator"
          style="
            min-height: 32px;
            font-size: 18px;
            font-family: 'Poppins', Arial, sans-serif;
            color: #00274c;
            font-weight: 500;
            margin: 0 0 18px 36px;
            text-align: left;
            display: block;
          "
        ></div>
        <div
          id="slideshow"
          style="
            width: 90%;
            height: 75vh;
            max-width: 1000px;
            max-height: 700px;
            min-width: 400px;
            min-height: 320px;
            position: relative;
            overflow: hidden;
            border-radius: 0;
            box-shadow: none;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
            padding: 0;
          "
        >
          <img
            class="slide-img"
            src="/images/Bridging the Physical and Digital Worlds.png"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 1;
              transform: scale(1.08);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <img
            class="slide-img"
            src="/images/Photorealistic_Altamonte Springs-2.jpg"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transform: scale(1);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <img
            class="slide-img"
            src="/images/Newyork cameras.png"
            style="
              width: 100%;
              height: 100%;
              object-fit: contain;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transform: scale(1);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <img
            class="slide-img"
            src="/images/statue of Liberty.png"
            style="
              width: 100%;
              height: 100%;
              object-fit: contain;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transform: scale(1);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <img
            class="slide-img"
            src="/images/Arcgis.png"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transform: scale(1);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <img
            class="slide-img"
            src="/images/newyork-1.jpeg"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
              position: absolute;
              top: 0;
              left: 0;
              opacity: 0;
              transform: scale(1);
              transition: opacity 1s, transform 1s;
              z-index: 1;
            "
          />
          <div
            id="slide-caption"
            style="
              position: absolute;
              bottom: 0;
              left: 0;
              width: 60%;
              height: 70px;
              background: linear-gradient(
                90deg,
                rgba(0, 39, 76, 0.68) 80%,
                rgba(0, 39, 76, 0)
              );
              color: #fff;
              padding: 18px 36px 10px 36px;
              border-radius: 0 18px 0 0;
              z-index: 2;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(2px);
              margin: 0 0 0 0;
              display: flex;
              flex-direction: column;
              justify-content: center;
            "
          >
            <h3
              style="
                margin: 0 0 4px 0;
                font-size: 1.1rem;
                font-weight: 700;
                letter-spacing: 0.5px;
                text-align: left;
                line-height: 1.2;
              "
            >
              Title
            </h3>
            <p
              style="
                margin: 0;
                font-size: 0.95rem;
                opacity: 0.92;
                font-weight: 400;
                text-align: left;
                line-height: 1.4;
              "
            >
              Subtitle
            </p>
          </div>
          <button
            id="slide-prev"
            style="
              position: absolute;
              top: 50%;
              left: 12px;
              transform: translateY(-50%);
              background: rgba(0, 0, 0, 0.3);
              color: #fff;
              border: none;
              border-radius: 50%;
              width: 36px;
              height: 36px;
              font-size: 1.5rem;
              cursor: pointer;
              z-index: 3;
            "
          >
            &#10094;
          </button>
          <button
            id="slide-next"
            style="
              position: absolute;
              top: 50%;
              right: 12px;
              transform: translateY(-50%);
              background: rgba(0, 0, 0, 0.3);
              color: #fff;
              border: none;
              border-radius: 50%;
              width: 36px;
              height: 36px;
              font-size: 1.5rem;
              cursor: pointer;
              z-index: 3;
            "
          >
            &#10095;
          </button>
          <div
            id="slide-dots"
            style="
              position: absolute;
              bottom: 18px;
              left: 0;
              width: 100%;
              text-align: center;
              z-index: 2;
            "
          ></div>
        </div>
      </div>
      <div
        class="auth-container"
        style="
          flex: 0 0 40vw;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: transparent;
        "
      >
        <div
          id="login-logo-bar"
          style="
            display: flex;
            align-items: center;
            gap: 16px;
            position: absolute;
            top: 24px;
            right: 32px;
            z-index: 10;
          "
        >
          <img
            src="/images/ucf -1.png"
            alt="UCF Logo"
            style="height: 50px; object-fit: contain"
          />
          <img
            src="/images/UDT_Logo-V01.png"
            alt="UDT Logo"
            style="height: 50px; object-fit: contain"
          />
        </div>
        <div
          style="
            width: 100%;
            max-width: 400px;
            margin-bottom: 50px;
            height: 80%;
          "
        >
          <div style="text-align: center; margin-bottom: 18px">
            <div
              style="
                font-size: 1.45rem;
                font-weight: bold;
                color: #00274c;
                letter-spacing: 0.5px;
              "
            >
              Urban Digital Twin Lab
            </div>
            <div
              style="
                font-size: 1.01rem;
                color: #555;
                margin-top: 4px;
                font-weight: 400;
              "
            >
              Building smart, sustainable cities through next‐gen simulation &
              data science.
            </div>
          </div>
          <h2 style="text-align: center; color: #1976d2">Sign In</h2>
          <form id="login-form" onsubmit="window.loginUser(event)">
            <input type="email" id="login-email" placeholder="Email" required />
            <input
              type="password"
              id="login-password"
              placeholder="Password"
              required
            />
            <div id="login-error" class="auth-error"></div>
            <button type="submit">Login</button>
            <div class="auth-links">
              <a
                href="#"
                id="forgotPasswordLink"
                style="color: #1976d2; text-decoration: none; font-size: 14px"
                >Forgot Password?</a
              >
            </div>
          </form>
          <p style="text-align: center">
            Don't have an account? <a href="register.html">Create one</a>
          </p>
        </div>
      </div>
    </div>
    <script type="module" src="/auth/supabase-auth.js"></script>
    <script type="module">
      import {
        auth,
        applyActionCode,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
      } from "/auth/supabase-auth.js";

      // Handle email verification
      async function handleEmailVerification() {
        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get("oobCode");
        const mode = urlParams.get("mode");

        if (oobCode) {
          if (mode === "resetPassword") {
            // Handle password reset
            try {
              // Show password reset form
              const form = document.querySelector("form");
              form.innerHTML = `
              <h2>Reset Password</h2>
              <input type="password" id="new-password" placeholder="New Password" required />
              <input type="password" id="confirm-password" placeholder="Confirm New Password" required />
              <div id="reset-error" class="auth-error"></div>
              <button type="submit">Reset Password</button>
            `;

              form.onsubmit = async (e) => {
                e.preventDefault();
                const newPassword =
                  document.getElementById("new-password").value;
                const confirmPassword =
                  document.getElementById("confirm-password").value;
                const errorDiv = document.getElementById("reset-error");

                if (newPassword !== confirmPassword) {
                  errorDiv.textContent = "Passwords do not match.";
                  return;
                }

                try {
                  await auth.confirmPasswordReset(oobCode, newPassword);
                  const messageDiv = document.createElement("div");
                  messageDiv.style.cssText =
                    "background-color: #d4edda; color: #155724; padding: 15px; margin: 10px 0; border-radius: 4px; text-align: center;";
                  messageDiv.textContent =
                    "Password reset successful! You can now log in with your new password.";
                  form.insertBefore(messageDiv, form.firstChild);
                  setTimeout(() => {
                    window.location.href = "login.html";
                  }, 3000);
                } catch (error) {
                  console.error("Error resetting password:", error);
                  if (error.code === "auth/expired-action-code") {
                    errorDiv.textContent =
                      "Password reset link has expired. Please request a new one.";
                    // Add button to request new reset link
                    const requestNewLinkBtn = document.createElement("button");
                    requestNewLinkBtn.textContent = "Request New Reset Link";
                    requestNewLinkBtn.style.cssText =
                      "margin-top: 10px; background-color: #6c757d;";
                    requestNewLinkBtn.onclick = (e) => {
                      e.preventDefault();
                      window.location.href = "login.html?requestReset=true";
                    };
                    form.appendChild(requestNewLinkBtn);
                  } else {
                    errorDiv.textContent = error.message;
                  }
                }
              };
            } catch (error) {
              console.error("Error handling password reset:", error);
            }
          } else {
            // Handle email verification
            try {
              await applyActionCode(auth, oobCode);
              const messageDiv = document.createElement("div");
              messageDiv.style.cssText =
                "background-color: #d4edda; color: #155724; padding: 15px; margin: 10px 0; border-radius: 4px; text-align: center;";
              messageDiv.textContent =
                "Email verified successfully! You can now log in.";
              document
                .querySelector("form")
                .insertBefore(
                  messageDiv,
                  document.querySelector("form").firstChild
                );
            } catch (error) {
              console.error("Error verifying email:", error);
              const messageDiv = document.createElement("div");
              messageDiv.style.cssText =
                "background-color: #f8d7da; color: #721c24; padding: 15px; margin: 10px 0; border-radius: 4px; text-align: center;";
              messageDiv.textContent =
                "Error verifying email. Please try again.";
              document
                .querySelector("form")
                .insertBefore(
                  messageDiv,
                  document.querySelector("form").firstChild
                );
            }
          }
        }
      }

      // Handle forgot password
      document
        .getElementById("forgotPasswordLink")
        .addEventListener("click", async function (e) {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          if (!email) {
            alert("Please enter your email address first.");
            return;
          }

          try {
            await sendPasswordResetEmail(auth, email);
            const messageDiv = document.createElement("div");
            messageDiv.style.cssText =
              "background-color: #d4edda; color: #155724; padding: 15px; margin: 10px 0; border-radius: 4px; text-align: center;";
            messageDiv.innerHTML = `
          Password reset email sent! Please check your inbox.<br>
          <small style="color: #666;">Note: The reset link will expire in 1 hour.</small>
        `;
            document
              .querySelector("form")
              .insertBefore(
                messageDiv,
                document.querySelector("form").firstChild
              );
          } catch (error) {
            console.error("Error sending password reset email:", error);
            const messageDiv = document.createElement("div");
            messageDiv.style.cssText =
              "background-color: #f8d7da; color: #721c24; padding: 15px; margin: 10px 0; border-radius: 4px; text-align: center;";
            messageDiv.textContent =
              "Error sending password reset email. Please try again.";
            document
              .querySelector("form")
              .insertBefore(
                messageDiv,
                document.querySelector("form").firstChild
              );
          }
        });

      // Call the verification handler when the page loads
      window.addEventListener("load", handleEmailVerification);
    </script>
    <script>
      const slideCaptions = [
        {
          title: "Digital twin Vision",
          subtitle: "Connecting physical and digital world of smart cities",
        },
        {
          title: "Photorealistic models",
          subtitle: "Immersive 3D environment for urban analysis",
        },
        {
          title: "Real-Time City Watch",
          subtitle: "Stream real-time feeds directly into 3D cityscape",
        },
        {
          title: "Photorealistic Visualization",
          subtitle: "Immersive fully rendered 3D models of cities",
        },
        {
          title: "Geospatial Intelligence",
          subtitle: "Integrating GIS and simulation for decision report",
        },
        {
          title: "New York City in 3D",
          subtitle:
            "Explore real-time data and visualization for the city that never sleeps.",
        },
      ];
      const slides = document.querySelectorAll(".slide-img");
      const dotsContainer = document.getElementById("slide-dots");
      const captionBox = document.getElementById("slide-caption");
      let slideIndex = 0;
      function showSlide(idx) {
        slides.forEach((img, i) => {
          if (i === idx) {
            img.style.opacity = "1";
            img.style.transform = "scale(1.08)";
          } else {
            img.style.opacity = "0";
            img.style.transform = "scale(1)";
          }
        });
        Array.from(dotsContainer.children).forEach(
          (dot, i) => (dot.className = i === idx ? "dot active" : "dot")
        );
        // Update caption
        captionBox.querySelector("h3").textContent = slideCaptions[idx].title;
        captionBox.querySelector("p").textContent = slideCaptions[idx].subtitle;
      }
      function nextSlide() {
        slideIndex = (slideIndex + 1) % slides.length;
        showSlide(slideIndex);
      }
      function prevSlide() {
        slideIndex = (slideIndex - 1 + slides.length) % slides.length;
        showSlide(slideIndex);
      }
      // Dots
      for (let i = 0; i < slides.length; i++) {
        const dot = document.createElement("span");
        dot.className = i === 0 ? "dot active" : "dot";
        dot.style.cssText =
          "display:inline-block;width:12px;height:12px;margin:0 4px;background:#1976d2;border-radius:50%;cursor:pointer;opacity:0.5;transition:opacity 0.2s;";
        dot.onclick = () => {
          slideIndex = i;
          showSlide(slideIndex);
        };
        dotsContainer.appendChild(dot);
      }
      document.getElementById("slide-next").onclick = nextSlide;
      document.getElementById("slide-prev").onclick = prevSlide;
      let slideInterval = setInterval(nextSlide, 3500);
      document.getElementById("slideshow").onmouseenter = () =>
        clearInterval(slideInterval);
      document.getElementById("slideshow").onmouseleave = () =>
        (slideInterval = setInterval(nextSlide, 3500));
      showSlide(0);

      const taglines = [
        "Where Data Meets 3D Reality",
        "Your City, Reimagined in 3D",
        "Transforming Urban Planning with Digital Twins",
      ];
      let taglineIndex = 0;
      let charIndex = 0;
      let typingTimeout, erasingTimeout, delayTimeout;
      const typingSpeed = 60;
      const erasingSpeed = 30;
      const delayBetween = 1200;
      const taglineElem = document.getElementById("tagline-rotator");
      function typeTagline() {
        if (charIndex < taglines[taglineIndex].length) {
          taglineElem.innerHTML =
            taglines[taglineIndex].substring(0, charIndex + 1) +
            '<span class="blinking-cursor">|</span>';
          charIndex++;
          typingTimeout = setTimeout(typeTagline, typingSpeed);
        } else {
          taglineElem.innerHTML =
            taglines[taglineIndex] + '<span class="blinking-cursor">|</span>';
          delayTimeout = setTimeout(eraseTagline, delayBetween);
        }
      }
      function eraseTagline() {
        if (charIndex > 0) {
          taglineElem.innerHTML =
            taglines[taglineIndex].substring(0, charIndex - 1) +
            '<span class="blinking-cursor">|</span>';
          charIndex--;
          erasingTimeout = setTimeout(eraseTagline, erasingSpeed);
        } else {
          taglineElem.innerHTML = '<span class="blinking-cursor">|</span>';
          taglineIndex = (taglineIndex + 1) % taglines.length;
          setTimeout(typeTagline, 400);
        }
      }
      typeTagline();
    </script>
  </body>
</html>
